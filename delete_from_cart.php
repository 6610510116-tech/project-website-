<?php
session_start();
include("dbconnect.php"); // р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Ар╕кр╣Йр╕Щр╕Чр╕▓р╕Зр╣Др╕Яр╕ер╣Мр╣Гр╕лр╣Йр╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З

// 1. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╕▓р╕гр╕ер╣Зр╕нр╕Бр╕нр╕┤р╕Щр╣Бр╕ер╕░р╕кр╕┤р╕Чр╕Шр╕┤р╣М
if (!isset($_SESSION['user_id']) || $_SESSION['role'] != 'student') {
    header("Location: login.php");
    exit();
}
$user_id = $_SESSION['user_id'];

// 2. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕бр╕╡р╕Бр╕▓р╕гр╕кр╣Ир╕З booking_id р╕бр╕▓р╕лр╕гр╕╖р╕нр╣Др╕бр╣И
if (isset($_GET['booking_id'])) {
    $booking_id = mysqli_real_escape_string($conn, $_GET['booking_id']);

    // 3. р╕кр╕гр╣Йр╕▓р╕Зр╕Др╕│р╕кр╕▒р╣Ир╕З DELETE
    // р╕Хр╣Йр╕нр╕Зр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ user_id р╣Ар╕Юр╕╖р╣Ир╕нр╕Ыр╣Йр╕нр╕Зр╕Бр╕▒р╕Щр╣Др╕бр╣Ир╣Гр╕лр╣Йр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Йр╕ер╕Ър╕гр╕▓р╕вр╕Бр╕▓р╕гр╕Вр╕нр╕Зр╕Др╕Щр╕нр╕╖р╣Ир╕Щ (Security Check)
    $delete_query = "DELETE FROM bookings 
                     WHERE id = '$booking_id' 
                     AND user_id = '$user_id' 
                     AND status = 'pending'";
    
    if (mysqli_query($conn, $delete_query)) {
        // р╕ер╕Ър╕кр╕│р╣Ар╕гр╣Зр╕И
        $message = "тЬЕ р╕ер╕Ър╕Др╕нр╕гр╣Мр╕кр╕нр╕нр╕Бр╕Ир╕▓р╕Бр╕Хр╕░р╕Бр╕гр╣Йр╕▓р╕кр╕│р╣Ар╕гр╣Зр╕Ир╣Бр╕ер╣Йр╕з";
    } else {
        // р╕ер╣Йр╕бр╣Ар╕лр╕ер╕з
        $message = "тЭМ р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╕ер╕Ъ: " . mysqli_error($conn);
    }
} else {
    // р╣Др╕бр╣Ир╕бр╕╡р╕Бр╕▓р╕гр╕кр╣Ир╕З ID р╕бр╕▓
    $message = "ЁЯЪл р╣Др╕бр╣Ир╕Юр╕Ър╕гр╕▓р╕вр╕Бр╕▓р╕гр╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╕ер╕Ъ";
}

// 4. Redirect р╕Бр╕ер╕▒р╕Ър╣Др╕Ыр╕лр╕Щр╣Йр╕▓р╕Хр╕░р╕Бр╕гр╣Йр╕▓р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Юр╕гр╣Йр╕нр╕бр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щ
header("Location: cart.php?msg=" . urlencode($message));
exit();

// р╕лр╕бр╕▓р╕вр╣Ар╕лр╕Хр╕╕: р╕Др╕╕р╕Ур╕Ир╕░р╕Хр╣Йр╕нр╕Зр╣Ар╕Юр╕┤р╣Ир╕б Logic р╣Гр╕Щ cart.php р╣Ар╕Юр╕╖р╣Ир╕нр╣Бр╕кр╕Фр╕З $_GET['msg'] р╕Фр╣Йр╕зр╕в
?>